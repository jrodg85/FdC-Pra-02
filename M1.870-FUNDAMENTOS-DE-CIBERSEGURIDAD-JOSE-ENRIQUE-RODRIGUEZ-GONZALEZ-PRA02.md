# M1.870 - Fundamentos de ciberseguridad.

# José Enrique Rodríguez González.

# PRACTICA 2.

---

## Indice.

- [Enunciado.](#enunciado)
- [Actividad.](#actividad)
- [Pregunta 1.](#pregunta-1)
- [Pregunta 2.](#pregunta-2)
- [Pregunta 3.](#pregunta-3)
- [Pregunta 4.](#pregunta-4)
- [Pregunta 5.](#pregunta-5)
- [Preparación del enunciado y de la actividad.](#preparación-del-enunciado-y-de-la-actividad)
- [Respuesta a la pregunta 1.](#respuesta-a-la-pregunta-1)
- [Respuesta a la pregunta 2.](#respuesta-a-la-pregunta-2)
- [Respuesta a la pregunta 3.](#respuesta-a-la-pregunta-3)
- [Respuesta a la pregunta 4.](#respuesta-a-la-pregunta-4)
- [Respuesta a la pregunta 5.1.](#respuesta-a-la-pregunta-51)
- [Respuesta a la pregunta 5.2.](#respuesta-a-la-pregunta-52)
- [Respuesta a la pregunta 5.3.](#respuesta-a-la-pregunta-53)

---

## Enunciado.

En esta segunda y última práctica usaremos también el mismo entorno de Kathará de la PEC 3 en algunos de los ejercicios (no en todos). Antes de continuar  debemos de realizar algunas puntualizaciones:

  - Para alguna de las actividades posteriores será necesario iniciar el entorno de Kathará en modo privilegiado. Por este motivo se pidió en la PEC3 anterior como pregunta. Se puede realizar de la siguiente manera:

~~~
sudo kathara lstart --privileged

sudo docker ps

sudo docker exec -t -i identificador_container_ bash
~~~

![Imagen 001](./Imagen-001.png)


También es posible abrir todos los terminales directamente con el bucle siguiente escrito en Bash:

~~~
for i in $(docker ps -q)

do xterm -e docker exec -it $i bash &

done
~~~

![Imagen 002](./Imagen-002.png)

- Comentar que Kathará no tiene persistencia así que recomendamos no cerrar el laboratorio y guardar el estado de la máquina virtual.

- Otra puntualización es que, para que las máquinas internas de la red puedan acceder correctamente a Internet deberemos de suprimir la regla siguiente en la máquina firewall<sup>1</sup>.

> <sup>1</sup>: Este es el primer semestre que usamos Kathará y nos estamos encontrando con situaciones diversas. Estamos en contacto con los desarrolladores para profundizar un poco más. Por ejemplo: https://github.com/KatharaFramework/Kathara/issues/211.

~~~
iptables -t nat -D PREROUTING -p tcp --dport 80 -j DNAT --to 5.5.5.2
~~~

Esta regla eliminará la redirección del puerto 80 desde la máquina Kali. Si deseamos acceder desde la máquina Kali a este puerto podemos añadirla de nuevo con:

~~~
iptables -t nat -A PREROUTING -p tcp --dport 80 -j DNAT --to 5.5.5.2
~~~

![Imagen 003](./Imagen-003.png)
> Añadimos nuevamente el diagrama de red implementado a modo de recordatorio. Es el mismo que el de la PEC3.

---

## Actividad.

Demostrad con capturas de pantalla de vuestro entorno las operaciones siguientes y responded a todas las preguntas.

Nota: aseguraros que aparezca en la shell vuestro nombre de usuario de la UOC en todas las capturas de pantalla. Podéis utilizar el comando:

~~~
export PS1=(gfarrasb)$PS1
~~~

Adicionalmente proporcionad una explicación para justificar qué realiza cada captura:

---

## Pregunta 1.

El administrador de red, conjuntamente con la Dirección de la empresa, han considerado que sería una buena idea realizar una acción de concienciación de phishing para todos trabajadores y empleados. Implementad una campaña de concienciación de phishing con el programa `Gophish`. Esta actividad está fuera de Kathará y, de hecho, podéis hacerla en el entorno que queráis. Demostrad que al menos un trabajador cae en el ataque de phishing y podéis ver su usuario y contraseña **(1.5 puntos)**.

---

## Pregunta 2.

El administrador de red quiere investigar si es posible lanzar un ataque de persistencia de clave SSH mediante `metasploit`<sup>2</sup> contra PC3 (se trata, en concreto, del módulo llamado SSH Key persistence - This module will add an SSH key to a specified user to allow remote login via SSH at any time) Aseguraros que, aunque user3 cambie la contraseña, el administrador podrá acceder igual a la máquina mediante la clave generada vía este módulo de metasploit **(1.5 puntos)**.

> <sup>2</sup>: Metasploit es una herramienta incorporada ya en Kali Linux que permite ejecutar exploits conocidos contra una máquina remota. No es necesario instalar nada ya que Kali la lleva por defecto.


---

## Pregunta 3.

El administrador de red ha descubierto que el servidor web de main.py contiene un bug que permite un Directory Transversal Attack. Se os pide arreglar el código de este servidor web escrito en Python para solucionarlo. El servidor web debería de poder entregar solamente ficheros de la carpeta de donde reside. **(1 punto)**.

---

## Pregunta 4.

Ahora resulta que el usuario de PC2 está enfadado contra el usuario de PC3 así que decide atacarlo. Ejecutará un ataque de DNS Spoofing contra una de las webs preferidas del usuario de PC3. Implementad un ataque de DNS spoofing usando la herramienta de terminal ettercap contra PC3 que use el dominio que consideréis. **(2 puntos)**


---

## Pregunta 5.

El usuario de PC3 nota que algo pasa en su ordenador y empieza a defenderse. Aplicará las siguientes protecciones:

1. Quiere evaluar el uso de unidades cifradas. Demostrad que podéis crear una disco cifrado mediante la herramienta zulucrypt. Esta actividad está fuera de Kathará e incluso de PC3. Implementadlo en la Kali nativa proporcionada. **(1 punto)**.

2. Quiere detectar mediante snort todas las conexiones SYN que entren en su máquina y ver una alerta por pantalla.**(1 punto)**.

3. Como ya duda de sus compañeros aplicará una regla en el cortafuegos (concretamente, usará la herramienta de terminal iptables) que solamente permita conexiones SSH desde fuera, no desde las máquinas internas (ni desde PC1 ni desde PC2, solamente desde firewall). **(1 punto)**.

---

## Preparación del enunciado y de la actividad.

Procedemos a importar la VM de la PEC 3.

![Imagen 004](./Imagen-004.png)

Una vez importado, ya que la maquina huesped que dispongo tiene bastante potencia, procedo a aprovecharla ampliando RAM y uso de CPU's

![Imagen 005](./Imagen-005.png)

![Imagen 006](./Imagen-006.png)

Procedo a abrir la terminal desde la carpeta de la PEC 3 y ejecuto el siguiente comando que se indica en la preparación de la actividad, de modo que los pantallazos son personalizados.

~~~
export PS1="(jrodriguezgonzalez6)$PS1"
~~~

![Imagen 007](./Imagen-007.png)



Procedemos a iniciar el entorno de Kathará en modo privilegiado, ejecutando en terminal los siguientes comandos:

~~~
sudo kathara lstart --privileged

sudo docker ps

~~~

El tercer comando lo considero innecesario realizarlo porque debajo del container id dice quien es cada uno.

![Imagen 008](./Imagen-008.png)

- En el container id `eb148e555dff`podemos ver la siguiente etiqueta de names kathara_kali-1so0mojtglk4ndbdpjxg_<u><font color='red'>**pc2**</font></u>_qUYEvZx4QtMbMsxR2UoQsg

- En el container id `fd051bfec9b8`podemos ver la siguiente etiqueta de names kathara_kali-1so0mojtglk4ndbdpjxg_<u><font color='red'>**webserver**</font></u>_qUYEvZx4QtMbMsxR2UoQsg

- En el container id `7d6e85d3d002`podemos ver la siguiente etiqueta de names kathara_kali-1so0mojtglk4ndbdpjxg_<u><font color='red'>**pc3**</font></u>_qUYEvZx4QtMbMsxR2UoQsg

- En el container id `4b82a915d1cc`podemos ver la siguiente etiqueta de names kathara_kali-1so0mojtglk4ndbdpjxg_<u><font color='red'>**pc1**</font></u>_qUYEvZx4QtMbMsxR2UoQsg

- En el container id `c9e0381c2ebc`podemos ver la siguiente etiqueta de names kathara_kali-1so0mojtglk4ndbdpjxg_<u><font color='red'>**firewall**</font></u>_qUYEvZx4QtMbMsxR2UoQsg

De este modo, quedan correctamente identificados, para entrar en la consola de cada uno de ellos procederemos segun lo indicado en el enunciado.

---

## Respuesta a la pregunta 1.

### Introducción.

Para cumplimentar este ejercicio, debo implementar una campaña de concienciación de phishing utilizando el programa Gophish. Nos aseguraremos de seguir las políticas y regulaciones éticas y legales cuando realices este tipo de actividades, como en este caso, estamos realizando una acción conjunta con la Dirección de la empresa, presumimos que tenemos la venia para realizarlo.

En esta pregunta desarrollaré los siguientes pasos:
1. [Instalación de Gophish.](#instalación-de-gophish)
2. [Configuración de la campaña.](#configuración-de-la-campaña)
3. [Ejecución de la campaña y recolección de datos]

### Instalación de Gophish.



- Instalaremos en la VM de kali, `Gophish` desde la [web oficial de Gophish](https://getgophish.com/)

![Imagen 009](./Imagen-009.png)


- Hacemos click en descargar y nos redirige al repositorio [github de Gophish](https://github.com/gophish/gophish/releases)

![Imagen 010](./Imagen-010.png)

- Descomprimimos y copiamos la carpeta en Documentos, para este paso, nos he procedido a buscar en youtube un tutorial relativo a la instalación de `Gophish` usando el siguiente enlace de [youtube](https://www.youtube.com/watch?v=lEX0OTrobn4&ab_channel=FaceITNet).

- Damos permiso para poder ejecutar el binario con `sudo chmod +x gophish`

![Imagen 011](./Imagen-011.png)

- Por ultimo ejecutamos el binario

![Imagen 012](./Imagen-012.png)

En el momento que nos aparezca en la consola `level=info msg="Starting admin server at https://127.0.0.1:3333"`, significa que `Gophish` se está ejecutando correctamente.

### Configuración de la campaña.

Para estas acciones, seguiremos usando como fuente el video de [youtube](https://www.youtube.com/watch?v=lEX0OTrobn4&ab_channel=FaceITNet) anteriormente indicado.

Una vez instalado el programa procederemos con la campaña, para ello primero de ello accederemos a la web `https://127.0.0.1:3333`, aceptaremos los riesgos que indican en la pantalla.

![Imagen 012](./Imagen-012.png)


A continuación entraremos en el login del la aplicación, para saber el admin y pass nos iremos a unos de los mensajes info que tenemos en la consola con la que hemos ejecutado `Gophish` que nos dice lo siquiente:

~~~
level=info msg="Please login with the username admin and the password a866395e00f77bcd"
~~~

- Procedemos a ingresar user y pass.






---

## Respuesta a la pregunta 2.







---

## Respuesta a la pregunta 3.






---

## Respuesta a la pregunta 4.








---

## Respuesta a la pregunta 5.1.







---

## Respuesta a la pregunta 5.2.






---

## Respuesta a la pregunta 5.3.






